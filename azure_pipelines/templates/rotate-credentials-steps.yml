parameters:
- name: azureServiceConnectionName
  displayName: Azure Service Connection name
  type: string
- name: mainKeyVaultName
  displayName: Main Key Vault Name
  type: string
- name: masterKeyVaultName
  displayName: Master Key Vault Name
  type: string
- name: keyVaultSecretNames
  displayName: Key Vault Secret Names
  type: object
  default: []

steps:
- checkout: none

- template: azcli/kv-get-secrets.yml
  parameters:
    azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}
    keyVaultName: ${{ parameters.masterKeyVaultName }}
    keyVaultSecretNames: ${{ parameters.keyVaultSecretNames }}

- ${{ each keyVaultSecretName in parameters.keyVaultSecretNames }}:
  - template: azcli/kv-create-secrets.yml
    parameters:
      azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}
      keyVaultName: ${{ parameters.mainKeyVaultName }}
      keyVaultSecretName: ${{ keyVaultSecretName }}
      keyVaultSecretValue: "$(${{ keyVaultSecretName }})"
      workingDirectory: $(System.DefaultWorkingDirectory)
