parameters:
  - name: azureServiceConnectionName
    displayName: Azure Service Connection name
    type: string
  - name: terraformVersion
    type: string
  - name: terraformResourceGroupName
    displayName: Resource group for TF
    type: string
  - name: terraformSaName
    displayName: Storage Account name for TF
    type: string
  - name: terraformBackendContainerName
    displayName: Container name for TF
    type: string
  - name: resourceGroupName
    displayName: Resource Group Name
    type: string
  # With defaults:
  - name: keyVaultName
    displayName: Key Vault Name
    type: string
  - name: keyVaultSecretNames
    displayName: Key vault secret names
    type: object
  - name: azClientIdName
    displayName: Key vault secret name to get the Client Id used for AZ CLI
    type: string
  - name: azClientSecretName
    displayName: Key vault secret name to get the Client Secret used for AZ CLI
    type: string
  - name: lifetimeSeconds
    displayName: Databricks Token Lifetime Seconds
    type: number
    default: 31536000 #one year
  - name: databricksSpnPatTokenName
    type: string
    displayName: Key Vault Secret Name for the Token value
  - name: databricksSpnPatTokenId
    type: string
    displayName: Key Vault Secret Name for the Token id
  - name: infrastructureModule
    displayName: Infrastructure module name
    type: string
  - name: comment
    displayName: Comment
    type: string

steps:
  - template: terraform-outputs.yml
    parameters:
      azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform/${{ parameters.infrastructureModule }}
      terraformVersion: ${{ parameters.terraformVersion }}
      terraformResourceGroupName: ${{ parameters.terraformResourceGroupName }}
      terraformSaName: ${{ parameters.terraformSaName }}
      terraformBackendContainerName: ${{ parameters.terraformBackendContainerName }}

  - template: azcli/kv-get-secrets.yml
    parameters:
      azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}
      keyVaultName: ${{ parameters.keyVaultName }}
      keyVaultSecretNames: ${{ parameters.keyVaultSecretNames }}

  - template: databricks/create-databricks-token.yml
    parameters:
      azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}
      databricksWorkspaceName: $(terraform_out_db_workspace_name)
      resourceGroupName: ${{ parameters.resourceGroupName }}
      lifetimeSeconds: ${{ parameters.lifetimeSeconds }}
      databricksWorkspaceUrl: $(workspaceURL)
      dbwSpClientId: $(${{ parameters.azClientIdName }})
      dbwSpClientSecret: $(${{ parameters.azClientSecretName }})
      comment: ${{ parameters.comment }}
      workingDirectory: $(System.DefaultWorkingDirectory)

  - template: azcli/kv-create-secrets.yml
    parameters:
      azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}
      keyVaultName: ${{ parameters.keyVaultName }}
      keyVaultSecretName: ${{ parameters.databricksSpnPatTokenName }}
      keyVaultSecretValue: $(spn_token_value_env)
      workingDirectory: $(System.DefaultWorkingDirectory)

  - template: azcli/kv-create-secrets.yml
    parameters:
      azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}
      keyVaultName: ${{ parameters.keyVaultName }}
      keyVaultSecretName: ${{ parameters.databricksSpnPatTokenId }}
      keyVaultSecretValue: $(spn_token_id_env)
      workingDirectory: $(System.DefaultWorkingDirectory)
