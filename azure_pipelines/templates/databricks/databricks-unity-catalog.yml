parameters:
  - name: azureServiceConnectionName
    displayName: Azure Service Connection name
    type: string
  - name: externalLocation
    displayName: External location name
    type: string
    default: ''
  - name: databricksObject 
    displayName: Databricks object name 
    type: string
  - name: catalogName
    displayName: Catalog name
    type: string
    default: ''
  - name: action
    displayName: Action to do with unity catalog
    values:
      - list
      - delete
  - name: commandOption
    displayName: Catalog name
    type: string
    default: ''

steps:
  - task: AzureCLI@2
    displayName: 'Unity Catalog: ${{ parameters.action }} ${{ parameters.databricksObject }}'
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnectionName }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "=============================================================="
        echo "${{ parameters.action }} ${{ parameters.databricksObject }}..."
        echo "=============================================================="
        if [ "${{ parameters.action }}" == "list" ]; then
          databricks ${{ parameters.databricksObject }} ${{ parameters.action }}
          if [[ $? -ne 0 ]]; then
            echo "##vso[task.logissue type=error;]Unable to ${{ parameters.action }}. Please verify your permissions and ensure that the specified workspace or context exists. If there are connectivity issues or the service is temporarily unavailable, try again later. Make sure you have the necessary privileges to access and ${{ parameters.action }} within the specified context."
          fi
        fi
        if   [[ -n "${{ parameters.externalLocation }}" ]]; then
          databricks ${{ parameters.databricksObject }} ${{ parameters.action }} "${{ parameters.externalLocation }}" ${{ parameters.commandOption }}
          if [[ $? -ne 0 ]]; then
            echo "##vso[task.logissue type=error;]Unable to ${{ parameters.action }} ${{ parameters.databricksObject }} in external location ${{ parameters.externalLocation }}. Please confirm that the specified catalog exists and that you have the necessary permissions to perform the deletion. Ensure that no active processes or configurations are dependent on this catalog before attempting to delete it. If the catalog is part of any ongoing transactions or has dependent objects, resolve those dependencies before proceeding with the deletion."
          fi
        fi
        if   [[ -n "${{ parameters.catalogName }}" ]]; then
          databricks ${{ parameters.databricksObject }} ${{ parameters.action }} "${{ parameters.catalogName }}"
          if [[ $? -ne 0 ]]; then
            echo "##vso[task.logissue type=error;]Unable to ${{ parameters.action }} ${{ parameters.databricksObject }} in external location ${{ parameters.catalogName }}. Please confirm that the specified catalog exists and that you have the necessary permissions to perform the deletion. Ensure that no active processes or configurations are dependent on this catalog before attempting to delete it. If the catalog is part of any ongoing transactions or has dependent objects, resolve those dependencies before proceeding with the deletion."
          fi
        fi